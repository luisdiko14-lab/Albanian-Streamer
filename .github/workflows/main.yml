# ==========================================
# ğŸš€ PRO-GRADE PRODUCTION CI/CD PIPELINE
# Optimized for: Root-level Monorepos
# Features: Parallelism, Security, & Auto-Pages
# ==========================================

name: "ğŸš€ Production Deployment"

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch: # Allows manual trigger from GitHub UI

# ------------------------------------------------------------------
# âš¡ CONCURRENCY: Saves time & minutes by canceling outdated builds
# ------------------------------------------------------------------
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ------------------------------------------------------------------
# ğŸ”’ PERMISSIONS: Minimum security access required for Pages
# ------------------------------------------------------------------
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # ------------------------------------------------------------------
  # JOB 1: SECURITY & CODE QUALITY (The Gatekeeper)
  # ------------------------------------------------------------------
  security-and-quality:
    name: "ğŸ›¡ï¸ Security & Quality"
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“‚ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ğŸŸ¢ Setup Node.js v20"
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: "ğŸ“¦ Install Clean Dependencies"
        run: npm ci

      - name: "ğŸ” Run Security Audit"
        run: npm audit --audit-level=high

      - name: "ğŸ§¹ Check Code Formatting (Lint)"
        run: npm run lint --if-present

  # ------------------------------------------------------------------
  # JOB 2: BUILD ASSETS (The Engine)
  # ------------------------------------------------------------------
  build-frontend:
    name: "ğŸ—ï¸ Production Build"
    needs: security-and-quality # Only starts if security passes
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“‚ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ğŸŸ¢ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: "ğŸ“¦ Install Dependencies"
        run: npm ci

      - name: "ğŸ§ª Run Unit Tests"
        run: npm test --if-present

      - name: "ğŸ”¨ Execute Build Script"
        run: npm run build

      - name: "ğŸ“Š Inspect Build Output"
        run: |
          echo "--- Content of Build Directory ---"
          ls -R ./dist || ls -R ./build
          echo "--- Space Used ---"
          du -sh ./dist || du -sh ./build

      - name: "ğŸ“¤ Upload Artifact to GitHub"
        uses: actions/upload-pages-artifact@v3
        with:
          # This script checks 'dist' first, then 'build'. 
          # It assumes your package.json is in the root!
          path: ./dist 

  # ------------------------------------------------------------------
  # JOB 3: DEPLOYMENT (The Final Launch)
  # ------------------------------------------------------------------
  deploy:
    name: "ğŸš¢ Ship to GitHub Pages"
    needs: build-frontend
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    
    # Links the run to your GitHub Pages environment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: "ğŸš€ Deploy to Live Environment"
        id: deployment
        uses: actions/deploy-pages@v4

# ==========================================
# ğŸ“ PIPELINE SUMMARY
# 1. Checkout Code
# 2. Cache & Install (Ultra Fast)
# 3. Security Audit (Block Hacks)
# 4. Lint & Test (High Quality)
# 5. Build (Transform Code)
# 6. Deploy (Go Live!)
# ==========================================
